function bytesToSize(a,b){return 0<=a&&1024>a?a+" B":1024<=a&&1048576>a?(a/1024).toFixed(b)+" KB":1048576<=a&&1073741824>a?(a/1048576).toFixed(b)+" MB":1073741824<=a&&1099511627776>a?(a/1073741824).toFixed(b)+" GB":1099511627776<=a?(a/1099511627776).toFixed(b)+" TB":a+" B"}
Number.prototype.toHHMMSS=function(){var a=parseInt(this,10);if(isNaN(a)||null===a)time="-";else{var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),a=a-3600*b-60*c;10>b&&(b="0"+b);10>c&&(c="0"+c);10>a&&(a="0"+a);time=b+"h"+c+"m"+a+"s";time=time.replace(/00[\w]{1}/g,"");isNaN(b)&&isNaN(c)&&isNaN(a)&&(time="\u221e")}return time};function capitaliseFirstLetter(a){return a.charAt(0).toUpperCase()+a.slice(1)}
Object.defineProperty(Array.prototype,"prepend",{enumerable:!1,configurable:!1,writable:!1,value:function(a){""!=a&&this.unshift(a);return this}});chrome.storage.local.get(null,function(a){var b;a.rpcuser?(b=a.rpcpath.replace(/(\:\/\/)/g,"$1"+a.rpcuser+":"+a.rpctoken+"@"),window.rpct=""):(b=a.rpcpath,window.rpct=a.rpctoken?"token:"+a.rpctoken:"");$.jsonRPC.setup({endPoint:b,namespace:"aria2"})});
function aria2CMD(a,b){chrome.storage.local.get(null,function(c){$.jsonRPC.request(a,{params:[b].prepend(rpct)})})}function addurisubmit(){for(var a=""==e_taskaddbox.value?e_taskaddbatch.value.split("\n"):e_taskaddbox.value.split("\n"),b=0,c=a.length;b<c;b++)aria2CMD("addUri",[a[b]]);e_addtaskctn.style.display="none";e_addbtn.value="Add"}
function addmoretoggle(){">>"==e_addmore.value?(e_taskaddbox.style.display="none",e_taskaddbatch.style.display="inline-block",e_addmore.value="<<"):(e_taskaddbox.style.display="inline-block",e_taskaddbatch.style.display="none",e_addmore.value=">>")}function addtasktoggle(){e_addtaskctn.style.display="none"!=e_addtaskctn.style.display?"none":"";e_addbtn.value="Add"==e_addbtn.value?"Cancel":"Add";e_taskaddbox.style.display="inline-block";e_taskaddbatch.style.display="none";e_addmore.value=">>"}
var e_purgebtn=document.getElementById("purgebtn"),e_addbtn=document.getElementById("addbtn"),e_addtask=document.getElementById("addtask"),e_addmore=document.getElementById("addmore"),e_addtaskctn=document.getElementById("addtaskcontainer"),e_taskaddbox=document.getElementById("taskaddbox"),e_taskaddbatch=document.getElementById("taskaddbatch"),e_tasklist=document.getElementById("tasklist"),headInfotpl=document.getElementById("headInfo").innerHTML,taskInfotpl=document.getElementById("taskInfo").innerHTML,
e_globalstat=document.getElementById("globalstat");e_purgebtn.addEventListener("click",function(){aria2CMD("purgeDownloadResult","")},!1);e_addbtn.addEventListener("click",function(){addtasktoggle()},!1);e_addmore.addEventListener("click",function(){addmoretoggle()},!1);e_addtask.addEventListener("submit",function(a){addurisubmit();a.preventDefault()},!1);
$(e_tasklist).on("click","button.removebtn",function(){var a=$(this).attr("class").split(" ")[0],b=$(this).attr("id").split("_").pop(),c;switch(a){case "active":case "waiting":case "paused":c="forceRemove";break;case "error":case "complete":case "removed":c="removeDownloadResult"}aria2CMD(c,b)});
$(e_tasklist).on("click","div.progbar",function(){var a=$(this).attr("class").split(" ")[0],b=$(this).attr("id").split("_").pop(),c;switch(a){case "active":case "waiting":c="pause";break;case "error":case "complete":case "removed":c="removeDownloadResult";break;case "paused":c="unpause"}aria2CMD(c,b)});Mustache.parse(headInfotpl);Mustache.parse(taskInfotpl);
function writeUI(){chrome.storage.local.get(null,function(a){$.jsonRPC.request("getGlobalStat",{params:[rpct],success:function(a){a=a.result;var c={};c.globspeed=0==a.downloadSpeed?"":bytesToSize(a.downloadSpeed,2)+"/s";c=Mustache.render(headInfotpl,a,c);e_globalstat.innerHTML=c;c="status gid completedLength totalLength files connections dir downloadSpeed bittorrent uploadSpeed numSeeders".split(" ");$.jsonRPC.batchRequest([{method:"tellActive",params:[c].prepend(rpct)},{method:"tellWaiting",params:[0,
parseInt(a.numWaiting),c].prepend(rpct)},{method:"tellStopped",params:[0,parseInt(a.numStopped),c].prepend(rpct)}],{success:function(a){0!==a[0].result.length+a[1].result.length+a[2].result.length||$(document).find(".tasktitle").length?printTask(a):e_tasklist.innerHTML="Empty task list"}})}})})}
function printTask(a){for(var b="",c=a.length,h=0;h<c;h++)for(var e=a[h].result,k=e.length,g,f={},d=0;d<k;d++)g=e[d].files,f.displayName=e[d].bittorrent&&e[d].bittorrent.info&&e[d].bittorrent.info.name?e[d].bittorrent.info.name:g[0].path.split("/").pop(),e[d].bittorrent?(f.upspeedPrec=" (up:"+bytesToSize(e[d].uploadSpeed,2)+"/s)",f.numSeedersf="/"+e[d].numSeeders.toString()+" seeds"):(f.upspeedPrec="",f.numSeedersf=""),f.dlspeedPrec=bytesToSize(e[d].downloadSpeed,2),f.tlengthPrec=bytesToSize(e[d].totalLength,
2),f.clengthPrec=bytesToSize(e[d].completedLength,2),f.completeRatio=parseFloat(e[d].completedLength/e[d].totalLength*100,2).toFixed(2).toString(),g=(e[d].totalLength-e[d].completedLength)/e[d].downloadSpeed,f.eta=g.toHHMMSS(),f.statusUpper=capitaliseFirstLetter(e[d].status),isNaN(e[d].completedLength)||0==e[d].completedLength?f.p="0%":f.p=parseFloat(e[d].completedLength/e[d].totalLength*100,2).toFixed(2).toString()+"%",b+=Mustache.render(taskInfotpl,e[d],f);e_tasklist.innerHTML=b}writeUI();
var uirefrsh=setInterval(writeUI,1E3);